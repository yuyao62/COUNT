<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>è—¥ä¸¸è¨ˆæ•¸ WebAppï¼ˆé AI ç‰ˆï¼‰</title>

<style>
body{font-family:Arial;margin:0;padding:14px;background:#fafafa}
.wrap{max-width:720px;margin:auto}
h1{text-align:center}
.panel{background:#fff;border-radius:14px;padding:12px;margin:12px 0}
video,canvas{width:100%;border-radius:12px;background:#111}
.row{display:flex;gap:10px;justify-content:center;margin-top:10px}
button{padding:10px 14px;font-size:16px;border-radius:12px;border:1px solid #ccc;background:#fff}
button.primary{border-color:#2563eb;color:#2563eb;font-weight:700}
#count{text-align:center;font-size:22px;font-weight:900;color:#2563eb;margin-top:10px}

/* iOS é»æ“Šä¿è­‰ */
video,canvas{pointer-events:none}
.row{position:relative;z-index:10}
</style>
</head>

<body>
<div class="wrap">
<h1>ğŸ’Š è—¥ä¸¸è¨ˆæ•¸ WebApp</h1>

<div class="panel">
  <video id="video" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>

  <div class="row">
    <button id="startBtn" class="primary">ğŸ¥ å•Ÿå‹•ç›¸æ©Ÿ</button>
    <button id="scanBtn" class="primary">ğŸ“¸ æƒæä¸¦è¨ˆæ•¸</button>
    <button id="stopBtn">â¹ åœæ­¢</button>
  </div>

  <div id="count">åµæ¸¬åˆ°è—¥ä¸¸æ•¸é‡ï¼š0</div>
</div>
</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const countDiv = document.getElementById('count');

let stream=null;

/* ===== ç›¸æ©Ÿ ===== */
async function startCamera(){
  stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:{ideal:'environment'}}, audio:false
  });
  video.srcObject = stream;
  await new Promise(r=>video.onloadedmetadata=r);
  await video.play();

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
}
function stopCamera(){
  if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
}

/* ===== æ ¸å¿ƒï¼šè—¥ä¸¸è¨ˆæ•¸ ===== */
function countPills(){
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  const img = ctx.getImageData(0,0,canvas.width,canvas.height);
  const data = img.data;
  const bw = [];

  // ç°éš + é–¾å€¼
  for(let i=0;i<data.length;i+=4){
    const g = 0.299*data[i]+0.587*data[i+1]+0.114*data[i+2];
    bw.push(g > 180 ? 1 : 0); // ç™½è‰²è—¥ä¸¸åäº®
  }

  const visited = new Uint8Array(bw.length);
  let count = 0;

  function flood(i){
    let stack=[i], area=0;
    while(stack.length){
      const p=stack.pop();
      if(visited[p]||!bw[p]) continue;
      visited[p]=1; area++;

      const x=p%canvas.width;
      const y=(p/canvas.width)|0;

      if(x>0) stack.push(p-1);
      if(x<canvas.width-1) stack.push(p+1);
      if(y>0) stack.push(p-canvas.width);
      if(y<canvas.height-1) stack.push(p+canvas.width);
    }
    return area;
  }

  // æ‰¾äº®è‰²å€å¡Š
  for(let i=0;i<bw.length;i++){
    if(bw[i] && !visited[i]){
      const area = flood(i);
      // é¢ç©éæ¿¾ï¼ˆä¾ä½ ç…§ç‰‡å¯¦æ¸¬ OKï¼‰
      if(area > 800 && area < 20000){
        count++;
      }
    }
  }

  countDiv.textContent = 'åµæ¸¬åˆ°è—¥ä¸¸æ•¸é‡ï¼š' + count;
}

/* ===== ç¶å®š ===== */
document.getElementById('startBtn').onclick=startCamera;
document.getElementById('stopBtn').onclick=stopCamera;
document.getElementById('scanBtn').onclick=countPills;
</script>
</body>
</html>
