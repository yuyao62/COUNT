<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>è—¥ä¸¸è¨ˆæ•¸ WebAppï¼ˆå³æ™‚ãƒ»é AIï¼‰</title>

<style>
body{font-family:Arial;margin:0;padding:14px;background:#fafafa}
.wrap{max-width:720px;margin:auto}
h1{text-align:center;margin:8px 0}
.panel{background:#fff;border-radius:14px;padding:12px;margin:12px 0}
video,canvas{width:100%;border-radius:12px;background:#111}
.row{display:flex;gap:10px;justify-content:center;margin-top:10px}
button{padding:10px 14px;font-size:16px;border-radius:12px;border:1px solid #ccc;background:#fff}
button.primary{border-color:#2563eb;color:#2563eb;font-weight:700}
#count{text-align:center;font-size:22px;font-weight:900;color:#2563eb;margin-top:10px}

/* iOS è§¸æ§ä¿è­‰ */
video,canvas{pointer-events:none}
.row{position:relative;z-index:10}
</style>
</head>

<body>
<div class="wrap">
<h1>ğŸ’Š è—¥ä¸¸è¨ˆæ•¸ WebAppï¼ˆå³æ™‚ãƒ»é AIï¼‰</h1>

<div class="panel">
  <video id="video" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>

  <div class="row">
    <button id="startBtn" class="primary">ğŸ¥ å•Ÿå‹•ç›¸æ©Ÿ</button>
    <button id="stopBtn">â¹ åœæ­¢</button>
  </div>

  <div id="count">åµæ¸¬åˆ°è—¥ä¸¸æ•¸é‡ï¼š0</div>
</div>
</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const countDiv = document.getElementById('count');

let stream=null;
let running=false;

/* ===== ç›¸æ©Ÿ ===== */
async function startCamera(){
  stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:{ideal:'environment'}}, audio:false
  });
  video.srcObject = stream;
  await new Promise(r=>video.onloadedmetadata=r);
  await video.play();

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  running = true;
  requestAnimationFrame(loop);
}
function stopCamera(){
  running=false;
  if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
}

/* ===== å³æ™‚è™•ç†ä¸»è¿´åœˆ ===== */
function loop(){
  if(!running) return;
  processFrame();
  requestAnimationFrame(loop);
}

/* ===== æ ¸å¿ƒï¼šå³æ™‚è—¥ä¸¸åµæ¸¬ ===== */
function processFrame(){
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const img = ctx.getImageData(0,0,canvas.width,canvas.height);
  const d = img.data;

  // è‡ªé©æ‡‰äº®åº¦é–€æª»ï¼ˆæ”¯æ´ä¸åŒé¡è‰²ï¼‰
  let sum=0;
  for(let i=0;i<d.length;i+=4){
    sum += 0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2];
  }
  const avg = sum / (d.length/4);
  const threshold = avg + 15; // æ¯”èƒŒæ™¯äº® or åäº®éƒ½æŠ“

  const bw = new Uint8Array(canvas.width * canvas.height);
  for(let i=0,j=0;i<d.length;i+=4,j++){
    const g = 0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2];
    bw[j] = g > threshold ? 1 : 0;
  }

  const visited = new Uint8Array(bw.length);
  let pills = [];

  function flood(i){
    let stack=[i], area=0;
    let minX=99999,minY=99999,maxX=0,maxY=0;

    while(stack.length){
      const p=stack.pop();
      if(visited[p]||!bw[p]) continue;
      visited[p]=1; area++;

      const x=p%canvas.width;
      const y=(p/canvas.width)|0;

      minX=Math.min(minX,x);
      minY=Math.min(minY,y);
      maxX=Math.max(maxX,x);
      maxY=Math.max(maxY,y);

      if(x>0) stack.push(p-1);
      if(x<canvas.width-1) stack.push(p+1);
      if(y>0) stack.push(p-canvas.width);
      if(y<canvas.height-1) stack.push(p+canvas.width);
    }

    return {area,w:maxX-minX+1,h:maxY-minY+1,cx:(minX+maxX)/2,cy:(minY+maxY)/2};
  }

  for(let i=0;i<bw.length;i++){
    if(bw[i] && !visited[i]){
      const b = flood(i);

      // é¢ç©éæ¿¾ï¼ˆä¾ä½ å ´æ™¯å¯¦æ¸¬ï¼‰
      if(b.area < 800 || b.area > 20000) continue;

      // å½¢ç‹€æ¥è¿‘åœ“
      const ratio = b.w / b.h;
      if(ratio < 0.7 || ratio > 1.4) continue;

      pills.push(b);
    }
  }

  // ç•«åœ“æ¡†
  ctx.strokeStyle = 'lime';
  ctx.lineWidth = 3;
  pills.forEach(p=>{
    const r = Math.max(p.w,p.h)/2;
    ctx.beginPath();
    ctx.arc(p.cx,p.cy,r,0,Math.PI*2);
    ctx.stroke();
  });

  countDiv.textContent = 'åµæ¸¬åˆ°è—¥ä¸¸æ•¸é‡ï¼š' + pills.length;
}

/* ===== ç¶å®š ===== */
document.getElementById('startBtn').onclick=startCamera;
document.getElementById('stopBtn').onclick=stopCamera;
</script>
</body>
</html>
