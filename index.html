<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>è—¥ä¸¸è¨ˆæ•¸ WebAppï¼ˆå³æ™‚ãƒ»é»æ¨™è¨˜ï¼‰</title>
<style>
  body{font-family:Arial;margin:0;padding:14px;background:#fafafa}
  .wrap{max-width:720px;margin:auto}
  h1{text-align:center;margin:8px 0}
  .panel{background:#fff;border-radius:14px;padding:12px;margin:12px 0}
  video,canvas{width:100%;border-radius:12px;background:#111}
  .row{display:flex;gap:10px;justify-content:center;margin-top:10px}
  button{padding:10px 14px;font-size:16px;border-radius:12px;border:1px solid #ccc;background:#fff}
  button.primary{border-color:#2563eb;color:#2563eb;font-weight:700}
  #count{text-align:center;font-size:22px;font-weight:900;color:#2563eb;margin-top:10px}
  .small{text-align:center;color:#6b7280;font-size:12px;margin-top:6px}

  /* iOS é»æ“Šä¿è­‰ */
  video,canvas{pointer-events:none}
  .row{position:relative;z-index:10}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ’Š è—¥ä¸¸è¨ˆæ•¸ WebAppï¼ˆå³æ™‚ãƒ»é»æ¨™è¨˜ï¼‰</h1>

  <div class="panel">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="canvas"></canvas>

    <div class="row">
      <button id="startBtn" class="primary">ğŸ¥ å•Ÿå‹•ç›¸æ©Ÿ</button>
      <button id="stopBtn">â¹ åœæ­¢</button>
    </div>

    <div id="count">åµæ¸¬åˆ°è—¥ä¸¸æ•¸é‡ï¼š0</div>
    <div class="small">é¡¯ç¤ºæ–¹å¼ï¼šä¸­å¿ƒé»ï¼ˆåå­—ï¼‰ï½œå·²åŠ åœ“å½¢åº¦éæ¿¾èˆ‡é˜²å¤§äº®å€èª¤åˆ¤</div>
  </div>
</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const countDiv = document.getElementById('count');

let stream=null;
let running=false;

// ç©©å®šè¼¸å‡ºï¼ˆé¿å…è·³å‹•ï¼‰
const hist = [];
const HIST_N = 8;
function stableCount(x){
  hist.push(x);
  if(hist.length>HIST_N) hist.shift();
  // çœ¾æ•¸
  const m = new Map();
  for(const v of hist) m.set(v,(m.get(v)||0)+1);
  let best = x, bestc = -1;
  for(const [k,c] of m.entries()){
    if(c>bestc){best=k;bestc=c;}
  }
  return best;
}

async function startCamera(){
  stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:{ideal:'environment'}}, audio:false
  });
  video.srcObject = stream;
  await new Promise(r=>video.onloadedmetadata=r);
  await video.play();
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  running = true;
  requestAnimationFrame(loop);
}
function stopCamera(){
  running=false;
  if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
}

function loop(){
  if(!running) return;
  processFrame();
  requestAnimationFrame(loop);
}

// å–äº®/æš—è—¥ä¸¸éƒ½èƒ½æŠ“ï¼šåŒæ™‚åšã€Œäº®ç‰©ä»¶ã€èˆ‡ã€Œæš—ç‰©ä»¶ã€å…©å¥— maskï¼Œæœ€å¾Œåˆä½µ
function processFrame(){
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const img = ctx.getImageData(0,0,canvas.width,canvas.height);
  const d = img.data;
  const W = canvas.width, H = canvas.height;
  const N = W*H;

  // å¹³å‡äº®åº¦
  let sum=0;
  for(let i=0;i<d.length;i+=4){
    sum += 0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2];
  }
  const avg = sum / (d.length/4);

  // é–¾å€¼ï¼ˆå¯å¾®èª¿ï¼‰
  const thBright = avg + 18;   // æŠ“ã€Œæ¯”èƒŒæ™¯äº®ã€çš„è—¥ä¸¸
  const thDark   = avg - 35;   // æŠ“ã€Œæ¯”èƒŒæ™¯æš—ã€çš„è—¥ä¸¸ï¼ˆæ·±è‰²è—¥ä¸¸ï¼‰

  const bwB = new Uint8Array(N);
  const bwD = new Uint8Array(N);

  for(let i=0,j=0;i<d.length;i+=4,j++){
    const g = 0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2];
    bwB[j] = (g > thBright) ? 1 : 0;
    bwD[j] = (g < thDark) ? 1 : 0;
  }

  // é‡å°å™ªé»ï¼šåšä¸€æ¬¡ç°¡å–®ã€Œ3x3 å¤šæ•¸æ±ºã€å¹³æ»‘ï¼ˆä¸ç”¨ OpenCVï¼‰
  function majority3x3(src){
    const out = new Uint8Array(N);
    for(let y=1;y<H-1;y++){
      for(let x=1;x<W-1;x++){
        let c=0;
        const p = y*W+x;
        c += src[p-W-1]+src[p-W]+src[p-W+1];
        c += src[p-1]   +src[p]  +src[p+1];
        c += src[p+W-1]+src[p+W]+src[p+W+1];
        out[p] = (c>=5)?1:0;
      }
    }
    return out;
  }

  const bw1 = majority3x3(bwB);
  const bw2 = majority3x3(bwD);

  // åˆä½µï¼ˆäº® or æš— å…¶ä¸­ä¸€å€‹æˆç«‹å°±ç®—ï¼‰
  const bw = new Uint8Array(N);
  for(let i=0;i<N;i++) bw[i] = (bw1[i]||bw2[i])?1:0;

  const visited = new Uint8Array(N);
  const pills = [];

  // flood å›å‚³ï¼šé¢ç©ã€bboxã€ä¸­å¿ƒã€å‘¨é•·(è¿‘ä¼¼)
  function flood(i){
    let stack=[i], area=0;
    let minX=1e9,minY=1e9,maxX=-1,maxY=-1;
    let perimeter=0;
    let sumX=0,sumY=0;

    while(stack.length){
      const p=stack.pop();
      if(visited[p]||!bw[p]) continue;
      visited[p]=1; area++;

      const x=p%W;
      const y=(p/W)|0;
      sumX+=x; sumY+=y;

      if(x<minX)minX=x; if(y<minY)minY=y;
      if(x>maxX)maxX=x; if(y>maxY)maxY=y;

      // é‚Šç•Œï¼šåªè¦å››é„°æœ‰ç©ºå°±ç®—å‘¨é•·ä¸€éƒ¨åˆ†ï¼ˆç²—ç•¥ä½†å¤ ç”¨ï¼‰
      const up    = (y>0)   ? bw[p-W] : 0;
      const down  = (y<H-1) ? bw[p+W] : 0;
      const left  = (x>0)   ? bw[p-1] : 0;
      const right = (x<W-1) ? bw[p+1] : 0;
      if(!(up && down && left && right)) perimeter++;

      if(x>0)   stack.push(p-1);
      if(x<W-1) stack.push(p+1);
      if(y>0)   stack.push(p-W);
      if(y<H-1) stack.push(p+W);
    }

    const cx = sumX/area;
    const cy = sumY/area;
    const w = maxX-minX+1;
    const h = maxY-minY+1;
    return {area,w,h,cx,cy,perimeter};
  }

  // æ‰¾ blob
  for(let i=0;i<N;i++){
    if(bw[i] && !visited[i]){
      const b = flood(i);

      // é¢ç©ï¼ˆä¾ä½ æ‹æ”è·é›¢ï¼Œé€™å€é–“å¾ˆé©åˆï¼šå¤ªå°æ˜¯é›œè¨Šï¼Œå¤ªå¤§æ˜¯å¡‘è† è¢‹/å¤§ç‰‡é«˜å…‰ï¼‰
      if(b.area < 900 || b.area > 28000) continue;

      // åŠå¾‘ä¸Šé™ï¼šé¿å…é‚£ç¨®è¶…å¤§äº®å€é€ æˆèª¤åˆ¤
      const r = Math.max(b.w,b.h)/2;
      if(r > 70) continue;

      // åœ“å½¢åº¦ circularity = 4Ï€A / P^2ï¼Œè¶Šæ¥è¿‘ 1 è¶Šåƒåœ“
      const circ = (4*Math.PI*b.area) / (b.perimeter*b.perimeter + 1e-6);
      if(circ < 0.35) continue; // å¤ªä¸åœ“çš„ï¼ˆå¡‘è† è¢‹é‚Š/éµç›¤é‚Šï¼‰æ’é™¤

      // å¯¬é«˜æ¯”å†ä¿éšªä¸€æ¬¡
      const ratio = b.w/b.h;
      if(ratio < 0.7 || ratio > 1.45) continue;

      pills.push(b);
    }
  }

  // ç•«ã€Œé»ã€ï¼šåå­— + å°åœ“
  ctx.drawImage(video,0,0,W,H);
  ctx.lineWidth = 3;
  ctx.strokeStyle = 'lime';
  ctx.fillStyle = 'lime';

  for(const p of pills){
    const x = p.cx, y = p.cy;

    // å°åœ“
    ctx.beginPath();
    ctx.arc(x,y,10,0,Math.PI*2);
    ctx.stroke();

    // åå­—
    ctx.beginPath();
    ctx.moveTo(x-12,y); ctx.lineTo(x+12,y);
    ctx.moveTo(x,y-12); ctx.lineTo(x,y+12);
    ctx.stroke();
  }

  const stable = stableCount(pills.length);
  countDiv.textContent = 'åµæ¸¬åˆ°è—¥ä¸¸æ•¸é‡ï¼š' + stable;
}

document.getElementById('startBtn').onclick=startCamera;
document.getElementById('stopBtn').onclick=stopCamera;
</script>
</body>
</html>
