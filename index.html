<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>è—¥ç²’è¨ˆæ•¸ WebApp (AIç‰ˆ)</title>

<style>
  body{font-family:Arial,sans-serif;margin:0;padding:14px;background:#fafafa}
  .wrap{max-width:760px;margin:0 auto}
  h1{text-align:center;margin:8px 0 14px}
  .panel{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px;margin:12px 0}
  .stage{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:720px){.stage{grid-template-columns:1fr}}
  video,canvas{width:100%;border-radius:12px;background:#0b1020}
  .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
  button{font-size:16px;padding:10px 14px;border-radius:12px;border:1px solid #d1d5db;background:#fff;cursor:pointer}
  button.primary{border-color:#1d4ed8;color:#1d4ed8;font-weight:800}
  button:disabled{opacity:.45;cursor:not-allowed}
  #count{text-align:center;font-size:22px;font-weight:900;color:#1d4ed8;margin-top:12px}
  .kv{display:grid;grid-template-columns:110px 1fr;gap:8px 10px;align-items:center}
  input[type="number"]{width:120px;padding:8px;border-radius:10px;border:1px solid #d1d5db}
  select{padding:8px;border-radius:10px;border:1px solid #d1d5db}
  .small{font-size:12px;color:#6b7280}
  #log{white-space:pre-wrap;background:#0b1020;color:#dbeafe;padding:10px;border-radius:12px;max-height:220px;overflow:auto;font-size:12px}

  /* iOS è§¸æ§ä¿è­‰ */
  video,canvas{pointer-events:none}
  .row{position:relative;z-index:9999}
  button{pointer-events:auto!important}
</style>
</head>

<body>
<div class="wrap">
<h1>ğŸ’Š è—¥ç²’è¨ˆæ•¸ WebApp (AIç‰ˆ)</h1>

<div class="panel">
  <div class="stage">
    <div>
      <div class="small">å³æ™‚ç›¸æ©Ÿ</div>
      <video id="video" autoplay muted playsinline></video>
    </div>
    <div>
      <div class="small">æƒæçµæœ</div>
      <canvas id="canvas"></canvas>
    </div>
  </div>

  <div class="row">
    <button id="startBtn" class="primary">ğŸ¥ å•Ÿå‹•ç›¸æ©Ÿ</button>
    <button id="scanBtn" class="primary" disabled>ğŸ“¸ æƒæä¸¦è¨ˆæ•¸</button>
    <button id="stopBtn" disabled>â¹ï¸ åœæ­¢ç›¸æ©Ÿ</button>
  </div>

  <div id="count">åµæ¸¬åˆ°è—¥ç²’æ•¸é‡ï¼š0</div>
</div>

<div class="panel">
  <div class="kv">
    <div>æ¨¡å‹è·¯å¾‘</div>
    <div><code id="modelPath">pill-model/model.json</code></div>

    <div>ä¿¡å¿ƒé–¾å€¼</div>
    <div>
      <input id="thr" type="number" min="0" max="1" step="0.05" value="0.40">
      <span class="small">å°ç‰©ä»¶å»ºè­° 0.2~0.4</span>
    </div>

    <div>æ¨è«–å°ºå¯¸</div>
    <div>
      <select id="inferSize">
        <option value="320">320</option>
        <option value="416">416</option>
        <option value="512" selected>512</option>
        <option value="640">640</option>
      </select>
    </div>

    <div>ç‹€æ…‹</div>
    <div id="status" class="small">å°šæœªå•Ÿå‹•</div>
  </div>
</div>

<div class="panel">
  <div class="small">HTTPS å¿…é ˆï¼›æ¨¡å‹è‹¥ 404 æœƒè‡ªå‹•é€€å›ã€Œå‚™æ´ count æ¨¡å¼ã€</div>
  <div id="log"></div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script>
/* ===== åŸºæœ¬ ===== */
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const startBtn=document.getElementById('startBtn');
const scanBtn=document.getElementById('scanBtn');
const stopBtn=document.getElementById('stopBtn');
const countDiv=document.getElementById('count');
const statusEl=document.getElementById('status');
const thrEl=document.getElementById('thr');
const inferSizeEl=document.getElementById('inferSize');
const logEl=document.getElementById('log');

let stream=null, model=null, modelLoaded=false;

function log(m){logEl.textContent=m+"\n"+logEl.textContent;console.log(m)}
function setStatus(s){statusEl.textContent=s}
function thr(){const v=Number(thrEl.value);return Number.isFinite(v)?Math.min(1,Math.max(0,v)):0.4}
function inferSize(){const v=Number(inferSizeEl.value);return Number.isFinite(v)?v:512}
function clearCanvas(){ctx.clearRect(0,0,canvas.width,canvas.height)}
function drawFrame(){ctx.drawImage(video,0,0,canvas.width,canvas.height)}

function stopCamera(){
  if(stream){stream.getTracks().forEach(t=>t.stop());stream=null}
  video.srcObject=null;scanBtn.disabled=true;stopBtn.disabled=true
}

async function waitMeta(){
  await new Promise(r=>{
    if(video.readyState>=2 && video.videoWidth>0) return r();
    video.onloadedmetadata=()=>r();
  });
}

/* ===== ç›¸æ©Ÿï¼ˆiOS ä¿å®ˆï¼‰ ===== */
async function startCamera(){
  setStatus('å•Ÿå‹•ç›¸æ©Ÿä¸­â€¦');
  stopCamera();
  video.muted=true; video.setAttribute('playsinline','');

  stream=await navigator.mediaDevices.getUserMedia({
    video:{facingMode:{ideal:'environment'}},audio:false
  });
  video.srcObject=stream;
  await waitMeta();
  try{await video.play()}catch{}
  await new Promise(r=>setTimeout(r,200));
  try{await video.play()}catch{}

  canvas.width=video.videoWidth||640;
  canvas.height=video.videoHeight||480;
  clearCanvas(); if(video.videoWidth>0) drawFrame();
  stopBtn.disabled=false;
  scanBtn.disabled=!modelLoaded;
  setStatus(`ç›¸æ©Ÿå·²å•Ÿå‹•ï¼š${canvas.width}x${canvas.height}`);
}

/* ===== è¼‰æ¨¡å‹ï¼ˆè‡ªå‹•ä¿®æ­£è·¯å¾‘ï¼‰ ===== */
async function loadModel(){
  setStatus('è¼‰å…¥æ¨¡å‹ä¸­â€¦');
  try{
    const url=new URL('pill-model/model.json',location.href).toString();
    log('load model: '+url);
    model=await tf.loadGraphModel(url);
    modelLoaded=true;
    scanBtn.disabled=false;
    setStatus('æ¨¡å‹è¼‰å…¥å®Œæˆï¼ˆAI æ¨¡å¼ï¼‰');
  }catch(e){
    log('æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼Œå•Ÿç”¨å‚™æ´æ¨¡å¼');
    setStatus('æ¨¡å‹ 404 â†’ å‚™æ´ count æ¨¡å¼');
    modelLoaded=false;
    scanBtn.disabled=false; // ä»å¯ countï¼ˆå‚™æ´ï¼‰
  }
}

/* ===== AI åµæ¸¬ count ===== */
async function detectAI(){
  const size=inferSize(), threshold=thr();
  const result=await tf.tidy(async()=>{
    const img=tf.browser.fromPixels(canvas).toFloat();
    const resized=tf.image.resizeBilinear(img,[size,size],true);
    const input=resized.div(255).expandDims(0);
    const out=await model.executeAsync(input);
    const boxesT=out['detection_boxes']||out[0];
    const scoresT=out['detection_scores']||out[1];
    const boxesArr=await boxesT.array();
    const scoresArr=await scoresT.array();
    if(Array.isArray(out)) out.forEach(t=>t.dispose&&t.dispose());
    else Object.values(out).forEach(t=>t.dispose&&t.dispose());
    const scores=(Array.isArray(scoresArr[0]))?scoresArr[0]:scoresArr;
    return scores.filter(s=>s>=threshold).length;
  });
  return result;
}

/* ===== å‚™æ´ countï¼ˆç¤ºç¯„ç”¨ï¼šé AIï¼‰ ===== */
function fallbackCount(){
  // ç°¡å–®ç¤ºç¯„ï¼šå›å‚³å›ºå®šå€¼ï¼ˆé¿å…æ•´å€‹å£æ‰ï¼‰
  return 0;
}

/* ===== äº‹ä»¶ ===== */
startBtn.onclick=async()=>{
  try{
    await startCamera();
    if(!modelLoaded) await loadModel();
  }catch(e){alert(e.message)}
};
stopBtn.onclick=()=>{stopCamera();setStatus('ç›¸æ©Ÿå·²åœæ­¢')};
scanBtn.onclick=async()=>{
  clearCanvas(); drawFrame();
  let c=0;
  if(modelLoaded){
    setStatus('AI è¨ˆæ•¸ä¸­â€¦');
    c=await detectAI();
  }else{
    setStatus('å‚™æ´è¨ˆæ•¸ä¸­â€¦');
    c=fallbackCount();
  }
  countDiv.textContent='åµæ¸¬åˆ°è—¥ç²’æ•¸é‡ï¼š '+c;
  setStatus('å®Œæˆ');
};

alert('JS å·²è¼‰å…¥');
setStatus('å°šæœªå•Ÿå‹•');
</script>
</body>
</html>
