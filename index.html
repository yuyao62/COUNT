<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>è—¥ç²’è¨ˆæ•¸ WebApp (AIç‰ˆ)</title>

  <style>
    body{font-family:Arial, sans-serif;margin:0;padding:14px;background:#fafafa}
    .wrap{max-width:760px;margin:0 auto}
    h1{text-align:center;margin:8px 0 14px;font-size:24px}

    .panel{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px;margin:12px 0}
    .stage{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.stage{grid-template-columns:1fr}}

    video,canvas{width:100%;border-radius:12px;background:#0b1020}

    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
    button{
      font-size:16px;padding:10px 14px;border-radius:12px;
      border:1px solid #d1d5db;background:#fff;cursor:pointer
    }
    button.primary{border-color:#1d4ed8;color:#1d4ed8;font-weight:800}
    button:disabled{opacity:.45;cursor:not-allowed}

    #count{text-align:center;font-size:22px;font-weight:900;color:#1d4ed8;margin-top:12px}

    .kv{display:grid;grid-template-columns:110px 1fr;gap:8px 10px;align-items:center}
    input[type="number"]{width:120px;padding:8px;border-radius:10px;border:1px solid #d1d5db}
    select{padding:8px;border-radius:10px;border:1px solid #d1d5db}
    code{background:#f3f4f6;padding:3px 8px;border-radius:8px}
    .small{font-size:12px;color:#6b7280;line-height:1.45}
    #log{white-space:pre-wrap;background:#0b1020;color:#dbeafe;padding:10px;border-radius:12px;max-height:260px;overflow:auto;font-size:12px}

    /* ğŸ”¥ iOS è§¸æ§ä¿è­‰ä¿®æ­£ï¼ˆé—œéµï¼‰ */
    video, canvas { pointer-events: none; }
    .row { position: relative; z-index: 9999; }
    button { pointer-events: auto !important; }
  </style>
</head>

<body>
<div class="wrap">
  <h1>ğŸ’Š è—¥ç²’è¨ˆæ•¸ WebApp (AIç‰ˆ)</h1>

  <div class="panel">
    <div class="stage">
      <div>
        <div class="small">å³æ™‚ç›¸æ©Ÿ</div>
        <!-- iOS å¿…å‚™ï¼šmuted + playsinline -->
        <video id="video" autoplay muted playsinline></video>
      </div>
      <div>
        <div class="small">æƒæçµæœ</div>
        <canvas id="canvas"></canvas>
      </div>
    </div>

    <div class="row">
      <button id="startBtn" class="primary">ğŸ¥ å•Ÿå‹•ç›¸æ©Ÿ</button>
      <button id="scanBtn" class="primary" disabled>ğŸ“¸ æƒæä¸¦è¨ˆæ•¸</button>
      <button id="stopBtn" disabled>â¹ï¸ åœæ­¢ç›¸æ©Ÿ</button>
      <button id="testBtn">ğŸ§ª æ¸¬è©¦æ¬Šé™</button>
    </div>

    <div id="count">åµæ¸¬åˆ°è—¥ç²’æ•¸é‡ï¼š0</div>
  </div>

  <div class="panel">
    <div class="kv">
      <div>æ¨¡å‹è·¯å¾‘</div>
      <div><code id="modelPath">pill-model/model.json</code></div>

      <div>ä¿¡å¿ƒé–¾å€¼</div>
      <div>
        <input id="thr" type="number" min="0" max="1" step="0.05" value="0.50" />
        <span class="small">ï¼ˆå°ç‰©ä»¶å»ºè­° 0.20~0.40ï¼‰</span>
      </div>

      <div>æ¨è«–å°ºå¯¸</div>
      <div>
        <select id="inferSize">
          <option value="320">320</option>
          <option value="416">416</option>
          <option value="512" selected>512</option>
          <option value="640">640</option>
        </select>
      </div>

      <div>ç‹€æ…‹</div>
      <div id="status" class="small">å°šæœªå•Ÿå‹•</div>
    </div>
  </div>

  <div class="panel">
    <div class="small">
      å¿…è¦æ¢ä»¶ï¼šHTTPSï¼ˆGitHub Pages OKï¼‰ã€‚è‹¥æ²’è·³ç›¸æ©Ÿæ¬Šé™ï¼Œå…ˆæŒ‰ã€ŒğŸ§ª æ¸¬è©¦æ¬Šé™ã€ã€‚
    </div>
    <div id="log"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>

<script>
  /* === åŸºæœ¬å·¥å…· === */
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  const startBtn = document.getElementById('startBtn');
  const scanBtn  = document.getElementById('scanBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const testBtn  = document.getElementById('testBtn');

  const countDiv = document.getElementById('count');
  const statusEl = document.getElementById('status');
  const thrEl = document.getElementById('thr');
  const inferSizeEl = document.getElementById('inferSize');
  const logEl = document.getElementById('log');
  const modelPathEl = document.getElementById('modelPath');

  let stream = null;
  let model = null;
  let modelLoaded = false;

  function log(msg){ logEl.textContent = msg + "\n" + logEl.textContent; console.log(msg); }
  function setStatus(s){ statusEl.textContent = s; }
  function isSecureOK(){
    const isLocal = location.hostname==='localhost'||location.hostname==='127.0.0.1';
    return location.protocol==='https:'||isLocal;
  }
  function thr(){ const v=Number(thrEl.value); return Number.isFinite(v)?Math.min(1,Math.max(0,v)):0.5; }
  function inferSize(){ const v=Number(inferSizeEl.value); return Number.isFinite(v)?v:512; }
  function clearCanvas(){ ctx.clearRect(0,0,canvas.width,canvas.height); }
  function drawFrame(){ ctx.drawImage(video,0,0,canvas.width,canvas.height); }

  function stopCamera(){
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    video.srcObject=null;
    scanBtn.disabled=true;
    stopBtn.disabled=true;
  }

  async function waitMeta(){
    await new Promise(r=>{
      if(video.readyState>=2 && video.videoWidth>0) return r();
      video.onloadedmetadata=()=>r();
    });
  }

  /* === iOS æœ€ä¿å®ˆå•Ÿå‹•æµç¨‹ === */
  async function startCameraIOSSafe(){
    if(!navigator.mediaDevices?.getUserMedia) throw new Error('ä¸æ”¯æ´ getUserMedia');
    if(!isSecureOK()) throw new Error('éœ€è¦ HTTPSï¼š'+location.href);

    setStatus('å•Ÿå‹•ç›¸æ©Ÿä¸­â€¦');
    stopCamera();

    video.setAttribute('playsinline','');
    video.muted = true;

    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ ideal:'environment' } }, audio:false
    });
    video.srcObject = stream;

    await waitMeta();
    try{ await video.play(); }catch(e){ log('play1 fail'); }
    await new Promise(r=>setTimeout(r,250));
    try{ await video.play(); }catch(e){ log('play2 fail'); }

    canvas.width = video.videoWidth||640;
    canvas.height = video.videoHeight||480;

    clearCanvas();
    if(video.videoWidth>0) drawFrame();

    setStatus(`ç›¸æ©Ÿå·²å•Ÿå‹•ï¼š${canvas.width}x${canvas.height}`);
    stopBtn.disabled=false;
    scanBtn.disabled=!modelLoaded;
  }

  /* === æ¨¡å‹ === */
  async function loadModel(){
    setStatus('è¼‰å…¥æ¨¡å‹ä¸­â€¦');
    model = await tf.loadGraphModel(modelPathEl.textContent.trim());
    modelLoaded = true;
    log('æ¨¡å‹å·²è¼‰å…¥');
    setStatus('æ¨¡å‹è¼‰å…¥å®Œæˆ');
    scanBtn.disabled=!stream;
  }

  /* === åµæ¸¬ï¼ˆä¿ç•™ï¼Œè‹¥æ¨¡å‹æœªå°é½Šæœƒé¡¯ç¤º 0ï¼‰ === */
  async function detectOnce(){
    if(!modelLoaded) throw new Error('æ¨¡å‹å°šæœªè¼‰å…¥');
    if(!stream) throw new Error('ç›¸æ©Ÿå°šæœªå•Ÿå‹•');

    canvas.width = video.videoWidth||canvas.width;
    canvas.height = video.videoHeight||canvas.height;
    clearCanvas(); drawFrame();

    const size = inferSize(), threshold = thr();
    setStatus(`æ¨è«–ä¸­â€¦ size=${size} thr=${threshold}`);

    const result = await tf.tidy(async()=>{
      const img = tf.browser.fromPixels(canvas).toFloat();
      const resized = tf.image.resizeBilinear(img,[size,size],true);
      const input = resized.div(255).expandDims(0);
      const out = await model.executeAsync(input);
      const boxesT = out['detection_boxes']||out[0];
      const scoresT= out['detection_scores']||out[1];
      const boxesArr = await boxesT.array();
      const scoresArr= await scoresT.array();
      if(Array.isArray(out)) out.forEach(t=>t.dispose&&t.dispose());
      else Object.values(out).forEach(t=>t.dispose&&t.dispose());
      const boxes = (Array.isArray(boxesArr[0])&&Array.isArray(boxesArr[0][0]))?boxesArr[0]:boxesArr;
      const scores=(Array.isArray(scoresArr[0]))?scoresArr[0]:scoresArr;
      return {boxes,scores};
    });

    clearCanvas(); drawFrame();
    let count=0;
    for(let i=0;i<result.scores.length;i++){
      if(result.scores[i]>=threshold) count++;
    }
    countDiv.textContent='åµæ¸¬åˆ°è—¥ç²’æ•¸é‡ï¼š'+count;
    setStatus('å®Œæˆ');
  }

  /* === äº‹ä»¶ï¼ˆç”¨ onclickï¼Œæœ€ä¿å®ˆï¼‰ === */
  startBtn.onclick = async ()=>{
    try{
      await startCameraIOSSafe();
      if(!modelLoaded) await loadModel();
    }catch(e){
      alert('ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼š'+e.message);
      setStatus('ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—');
    }
  };
  stopBtn.onclick = ()=>{ stopCamera(); setStatus('ç›¸æ©Ÿå·²åœæ­¢'); };
  scanBtn.onclick = async ()=>{ try{ await detectOnce(); }catch(e){ alert(e.message); } };

  testBtn.onclick = async ()=>{
    alert('ä½ æœ‰æŒ‰åˆ°ã€Œæ¸¬è©¦æ¬Šé™ã€');
    try{
      const s = await navigator.mediaDevices.getUserMedia({video:true,audio:false});
      s.getTracks().forEach(t=>t.stop());
      alert('getUserMedia æˆåŠŸï¼ˆæ¬Šé™ OKï¼‰');
    }catch(e){
      alert('getUserMedia å¤±æ•—ï¼š'+(e.name||'Error'));
    }
  };

  /* åˆå§‹åŒ– */
  alert('JS å·²è¼‰å…¥ï¼ˆçœ‹åˆ°é€™å€‹ä»£è¡¨ script æ­£å¸¸ï¼‰');
  setStatus('å°šæœªå•Ÿå‹•');
</script>
</body>
</html>
