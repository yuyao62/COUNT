<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>è—¥ä¸¸è¨ˆæ•¸ WebAppï¼ˆå³æ™‚ãƒ»ROIï¼‰</title>
<style>
  body{font-family:Arial;margin:0;padding:14px;background:#fafafa}
  .wrap{max-width:720px;margin:auto}
  h1{text-align:center;margin:8px 0}
  .panel{background:#fff;border-radius:14px;padding:12px;margin:12px 0}
  .stage{position:relative}
  video,canvas{width:100%;border-radius:12px;background:#111;display:block}
  canvas{position:absolute;left:0;top:0}
  .row{display:flex;gap:10px;justify-content:center;margin-top:10px}
  button{padding:10px 14px;font-size:16px;border-radius:12px;border:1px solid #ccc;background:#fff}
  button.primary{border-color:#2563eb;color:#2563eb;font-weight:700}
  #count{text-align:center;font-size:22px;font-weight:900;color:#2563eb;margin-top:10px}
  .small{text-align:center;color:#6b7280;font-size:12px;margin-top:6px;line-height:1.4}

  /* iOS é»æ“Šä¿è­‰ï¼švideo ä¸åƒè§¸æ§ï¼›canvas è¦åƒ(æ‹– ROI) */
  video{pointer-events:none}
  canvas{pointer-events:auto}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ’Š è—¥ä¸¸è¨ˆæ•¸ WebAppï¼ˆå³æ™‚ãƒ»ROIï¼‰</h1>

  <div class="panel">
    <div class="stage">
      <video id="video" autoplay muted playsinline></video>
      <canvas id="canvas"></canvas>
    </div>

    <div class="row">
      <button id="startBtn" class="primary">ğŸ¥ å•Ÿå‹•ç›¸æ©Ÿ</button>
      <button id="stopBtn">â¹ åœæ­¢</button>
      <button id="centerBtn">ğŸ§² ROI ç½®ä¸­</button>
      <button id="resetBtn">â†©ï¸ ROI é‡è¨­</button>
    </div>

    <div id="count">åµæ¸¬åˆ°è—¥ä¸¸æ•¸é‡ï¼š0</div>
    <div class="small">
      åªè¨ˆæ•¸ ROI æ¡†å…§çš„è—¥ä¸¸ã€‚<br>
      æ“ä½œï¼šæ‹– ROI ç§»å‹•ï½œæ‹–å³ä¸‹è§’å°æ–¹å¡Šç¸®æ”¾
    </div>
  </div>
</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const countDiv = document.getElementById('count');

let stream=null;
let running=false;

// ç©©å®šè¼¸å‡ºï¼ˆé¿å…è·³å‹•ï¼‰
const hist = [];
const HIST_N = 8;
function stableCount(x){
  hist.push(x);
  if(hist.length>HIST_N) hist.shift();
  const m=new Map();
  for(const v of hist) m.set(v,(m.get(v)||0)+1);
  let best=x, bestc=-1;
  for(const [k,c] of m.entries()){ if(c>bestc){best=k;bestc=c;} }
  return best;
}

/* ===== ROIï¼ˆä»¥ canvas åƒç´ åº§æ¨™ï¼‰===== */
let roi = { x: 0, y: 0, w: 0, h: 0 };
function setDefaultROI(){
  const W=canvas.width, H=canvas.height;
  const side = Math.round(Math.min(W,H) * 0.55);
  roi.w = side;
  roi.h = side;
  roi.x = Math.round((W - side)/2);
  roi.y = Math.round((H - side)/2);
}
function clampROI(){
  roi.w = Math.max(120, Math.min(roi.w, canvas.width));
  roi.h = Math.max(120, Math.min(roi.h, canvas.height));
  roi.x = Math.max(0, Math.min(roi.x, canvas.width - roi.w));
  roi.y = Math.max(0, Math.min(roi.y, canvas.height - roi.h));
}

/* ===== ç›¸æ©Ÿ ===== */
async function startCamera(){
  stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:{ideal:'environment'}}, audio:false
  });
  video.srcObject = stream;
  await new Promise(r=>video.onloadedmetadata=r);
  await video.play();

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  setDefaultROI();
  clampROI();

  running = true;
  requestAnimationFrame(loop);
}
function stopCamera(){
  running=false;
  if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
}

/* ===== ROI æ‹–æ‹‰ / ç¸®æ”¾ ===== */
let dragging=false, resizing=false;
let start={x:0,y:0,rx:0,ry:0,rw:0,rh:0};

function getCanvasPos(e){
  const rect = canvas.getBoundingClientRect();
  const px = (e.clientX - rect.left) * (canvas.width / rect.width);
  const py = (e.clientY - rect.top)  * (canvas.height/ rect.height);
  return {x:px,y:py};
}
function hitHandle(p){
  // å³ä¸‹è§’ç¸®æ”¾å°æ–¹å¡Š
  const hx = roi.x + roi.w, hy = roi.y + roi.h;
  const s = 26; // hit size (px)
  return (Math.abs(p.x-hx) <= s && Math.abs(p.y-hy) <= s);
}
function hitROI(p){
  return (p.x>=roi.x && p.x<=roi.x+roi.w && p.y>=roi.y && p.y<=roi.y+roi.h);
}

canvas.addEventListener('pointerdown', (e)=>{
  if(!running) return;
  canvas.setPointerCapture(e.pointerId);
  const p=getCanvasPos(e);
  start = { x:p.x, y:p.y, rx:roi.x, ry:roi.y, rw:roi.w, rh:roi.h };
  if(hitHandle(p)){
    resizing=true; dragging=false;
  }else if(hitROI(p)){
    dragging=true; resizing=false;
  }else{
    dragging=false; resizing=false;
  }
});
canvas.addEventListener('pointermove', (e)=>{
  if(!running) return;
  if(!dragging && !resizing) return;
  const p=getCanvasPos(e);
  const dx=p.x-start.x, dy=p.y-start.y;

  if(dragging){
    roi.x = start.rx + dx;
    roi.y = start.ry + dy;
  }else if(resizing){
    roi.w = start.rw + dx;
    roi.h = start.rh + dy;
  }
  clampROI();
});
canvas.addEventListener('pointerup', (e)=>{
  dragging=false; resizing=false;
});

/* ===== å³æ™‚ä¸»è¿´åœˆ ===== */
function loop(){
  if(!running) return;
  processFrame();
  requestAnimationFrame(loop);
}

/* ===== æ ¸å¿ƒï¼šåªåœ¨ ROI å…§åµæ¸¬ ===== */
function processFrame(){
  const W=canvas.width, H=canvas.height;

  // å…ˆç•«åº•åœ–
  ctx.drawImage(video,0,0,W,H);

  // åªå– ROI çš„åƒç´ åšåˆ†æ
  const rx = Math.round(roi.x), ry=Math.round(roi.y);
  const rw = Math.round(roi.w), rh=Math.round(roi.h);

  const img = ctx.getImageData(rx,ry,rw,rh);
  const d = img.data;
  const N = rw*rh;

  // ROI å¹³å‡äº®åº¦
  let sum=0;
  for(let i=0;i<d.length;i+=4){
    sum += 0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2];
  }
  const avg = sum / (d.length/4);

  // é–¾å€¼ï¼ˆå¤šè‰²ï¼šäº®/æš—éƒ½åšï¼‰
  const thBright = avg + 18;
  const thDark   = avg - 35;

  const bwB = new Uint8Array(N);
  const bwD = new Uint8Array(N);
  for(let i=0,j=0;i<d.length;i+=4,j++){
    const g = 0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2];
    bwB[j] = (g > thBright) ? 1 : 0;
    bwD[j] = (g < thDark) ? 1 : 0;
  }

  // 3x3 å¤šæ•¸æ±ºå¹³æ»‘
  function majority3x3(src){
    const out = new Uint8Array(N);
    for(let y=1;y<rh-1;y++){
      for(let x=1;x<rw-1;x++){
        let c=0;
        const p=y*rw+x;
        c += src[p-rw-1]+src[p-rw]+src[p-rw+1];
        c += src[p-1]   +src[p]  +src[p+1];
        c += src[p+rw-1]+src[p+rw]+src[p+rw+1];
        out[p] = (c>=5)?1:0;
      }
    }
    return out;
  }

  const mB = majority3x3(bwB);
  const mD = majority3x3(bwD);

  const bw = new Uint8Array(N);
  for(let i=0;i<N;i++) bw[i] = (mB[i]||mD[i])?1:0;

  const visited = new Uint8Array(N);
  const pills=[];

  function flood(i){
    let stack=[i], area=0;
    let minX=1e9,minY=1e9,maxX=-1,maxY=-1;
    let perimeter=0;
    let sumX=0,sumY=0;

    while(stack.length){
      const p=stack.pop();
      if(visited[p]||!bw[p]) continue;
      visited[p]=1; area++;

      const x=p%rw;
      const y=(p/rw)|0;
      sumX+=x; sumY+=y;

      if(x<minX)minX=x; if(y<minY)minY=y;
      if(x>maxX)maxX=x; if(y>maxY)maxY=y;

      const up    = (y>0)   ? bw[p-rw] : 0;
      const down  = (y<rh-1)? bw[p+rw] : 0;
      const left  = (x>0)   ? bw[p-1] : 0;
      const right = (x<rw-1)? bw[p+1] : 0;
      if(!(up && down && left && right)) perimeter++;

      if(x>0)   stack.push(p-1);
      if(x<rw-1)stack.push(p+1);
      if(y>0)   stack.push(p-rw);
      if(y<rh-1)stack.push(p+rw);
    }

    const cx = sumX/area;
    const cy = sumY/area;
    const w = maxX-minX+1;
    const h = maxY-minY+1;
    return {area,w,h,cx,cy,perimeter};
  }

  for(let i=0;i<N;i++){
    if(bw[i] && !visited[i]){
      const b=flood(i);

      // é¢ç©ï¼ˆROI å…§å°ºåº¦ï¼‰ï¼šå¯ä¾ä½ æ‹æ”è·é›¢å¾®èª¿
      if(b.area < 900 || b.area > 28000) continue;

      // åŠå¾‘ä¸Šé™ï¼ˆé¿å…äº®å€ï¼‰
      const r=Math.max(b.w,b.h)/2;
      if(r>70) continue;

      // åœ“å½¢åº¦
      const circ=(4*Math.PI*b.area)/(b.perimeter*b.perimeter+1e-6);
      if(circ<0.35) continue;

      // å¯¬é«˜æ¯”
      const ratio=b.w/b.h;
      if(ratio<0.7 || ratio>1.45) continue;

      pills.push({ ...b, r });
    }
  }

  // ===== ç•« ROI æ¡† =====
  // ROI å¤–æ·¡åŒ–ä¸€é»ï¼ˆè¦–è¦ºèšç„¦ï¼‰
  ctx.save();
  ctx.fillStyle = 'rgba(0,0,0,0.18)';
  ctx.fillRect(0,0,W,H);
  ctx.clearRect(rx,ry,rw,rh);
  ctx.restore();

  ctx.save();
  ctx.strokeStyle='rgba(59,130,246,0.95)'; // è—æ¡†
  ctx.lineWidth=4;
  ctx.strokeRect(rx,ry,rw,rh);

  // å³ä¸‹è§’ç¸®æ”¾æŠŠæ‰‹
  ctx.fillStyle='rgba(59,130,246,0.95)';
  ctx.fillRect(rx+rw-10, ry+rh-10, 20, 20);
  ctx.restore();

  // ===== ç•«é»ï¼ˆROI å…§ï¼‰=====
  ctx.save();
  ctx.strokeStyle='lime';
  ctx.lineWidth=3;
  for(const p of pills){
    const x = rx + p.cx;
    const y = ry + p.cy;

    // å°åœ“
    ctx.beginPath();
    ctx.arc(x,y,10,0,Math.PI*2);
    ctx.stroke();

    // åå­—
    ctx.beginPath();
    ctx.moveTo(x-12,y); ctx.lineTo(x+12,y);
    ctx.moveTo(x,y-12); ctx.lineTo(x,y+12);
    ctx.stroke();
  }
  ctx.restore();

  const stable = stableCount(pills.length);
  countDiv.textContent='åµæ¸¬åˆ°è—¥ä¸¸æ•¸é‡ï¼š'+stable;
}

/* ===== æŒ‰éˆ• ===== */
document.getElementById('startBtn').onclick=startCamera;
document.getElementById('stopBtn').onclick=stopCamera;
document.getElementById('centerBtn').onclick=()=>{
  if(!running) return;
  setDefaultROI(); clampROI();
};
document.getElementById('resetBtn').onclick=()=>{
  if(!running) return;
  setDefaultROI(); clampROI();
  hist.length=0;
};
</script>
</body>
</html>
