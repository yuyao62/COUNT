<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>è—¥ç²’è¨ˆæ•¸ WebApp (AIç‰ˆ)</title>
  <style>
    body{font-family:Arial, sans-serif;margin:0;padding:14px;background:#fafafa}
    .wrap{max-width:760px;margin:0 auto}
    h1{text-align:center;margin:8px 0 14px;font-size:24px}
    .panel{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px;margin:12px 0}
    .stage{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.stage{grid-template-columns:1fr}}
    video,canvas{width:100%;border-radius:12px;background:#0b1020}
    .tag{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-weight:700;font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
    button{font-size:16px;padding:10px 14px;border-radius:12px;border:1px solid #d1d5db;background:#fff;cursor:pointer}
    button.primary{border-color:#1d4ed8;color:#1d4ed8;font-weight:800}
    button:disabled{opacity:.45;cursor:not-allowed}
    #count{text-align:center;font-size:22px;font-weight:900;color:#1d4ed8;margin-top:12px}
    .kv{display:grid;grid-template-columns:110px 1fr;gap:8px 10px;align-items:center}
    input[type="number"]{width:120px;padding:8px;border-radius:10px;border:1px solid #d1d5db}
    select{padding:8px;border-radius:10px;border:1px solid #d1d5db}
    code{background:#f3f4f6;padding:3px 8px;border-radius:8px}
    .small{font-size:12px;color:#6b7280;line-height:1.45}
    #log{white-space:pre-wrap;background:#0b1020;color:#dbeafe;padding:10px;border-radius:12px;max-height:260px;overflow:auto;font-size:12px}
  </style>
</head>

<body>
<div class="wrap">
  <h1>ğŸ’Š è—¥ç²’è¨ˆæ•¸ WebApp (AIç‰ˆ)</h1>

  <div class="panel">
    <div class="stage">
      <div>
        <div class="small"><span class="tag">å³æ™‚ç›¸æ©Ÿ</span></div>
        <!-- iOS å¿…å‚™ï¼šmuted + playsinlineï¼›å¦å¤– JS æœƒå† setAttribute ä¸€æ¬¡ -->
        <video id="video" autoplay muted playsinline></video>
      </div>
      <div>
        <div class="small"><span class="tag">æƒæçµæœ</span></div>
        <canvas id="canvas"></canvas>
      </div>
    </div>

    <div class="row">
      <button id="startBtn" class="primary">ğŸ¥ å•Ÿå‹•ç›¸æ©Ÿ</button>
      <button id="scanBtn" class="primary" disabled>ğŸ“¸ æƒæä¸¦è¨ˆæ•¸</button>
      <button id="stopBtn" disabled>â¹ï¸ åœæ­¢ç›¸æ©Ÿ</button>
      <button id="testBtn">ğŸ§ª æ¸¬è©¦æ¬Šé™</button>
    </div>

    <div id="count">åµæ¸¬åˆ°è—¥ç²’æ•¸é‡ï¼š0</div>
  </div>

  <div class="panel">
    <div class="kv">
      <div>æ¨¡å‹è·¯å¾‘</div>
      <div><code id="modelPath">pill-model/model.json</code></div>

      <div>ä¿¡å¿ƒé–¾å€¼</div>
      <div>
        <input id="thr" type="number" min="0" max="1" step="0.05" value="0.50" />
        <span class="small">ï¼ˆå°ç‰©ä»¶å»ºè­° 0.20~0.40ï¼‰</span>
      </div>

      <div>æ¨è«–å°ºå¯¸</div>
      <div>
        <select id="inferSize">
          <option value="320">320</option>
          <option value="416">416</option>
          <option value="512" selected>512</option>
          <option value="640">640</option>
        </select>
        <span class="small">ï¼ˆå…ˆ resize å†é€æ¨¡å‹ï¼‰</span>
      </div>

      <div>ç‹€æ…‹</div>
      <div id="status" class="small">å°šæœªå•Ÿå‹•</div>
    </div>
  </div>

  <div class="panel">
    <div class="small">
      å¿…è¦æ¢ä»¶ï¼š<b>HTTPS</b>ï¼ˆGitHub Pages OKï¼‰ã€‚è‹¥æŒ‰å•Ÿå‹•ç›¸æ©Ÿæ²’è·³ã€Œå…è¨±ç›¸æ©Ÿã€ï¼Œè«‹å…ˆæŒ‰ã€ŒğŸ§ª æ¸¬è©¦æ¬Šé™ã€çœ‹éŒ¯èª¤åç¨±ã€‚
    </div>
    <div id="log"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script>
  // ===== DOM =====
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  const startBtn = document.getElementById('startBtn');
  const scanBtn  = document.getElementById('scanBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const testBtn  = document.getElementById('testBtn');

  const countDiv = document.getElementById('count');
  const statusEl = document.getElementById('status');
  const thrEl = document.getElementById('thr');
  const inferSizeEl = document.getElementById('inferSize');
  const logEl = document.getElementById('log');
  const modelPathEl = document.getElementById('modelPath');

  // ===== ç‹€æ…‹ =====
  let stream = null;
  let model = null;
  let modelLoaded = false;

  function log(...args){
    const msg = args.map(x => (typeof x === 'string' ? x : JSON.stringify(x, null, 2))).join(' ');
    console.log(...args);
    logEl.textContent = msg + "\n" + logEl.textContent;
  }
  function setStatus(s){ statusEl.textContent = s; }

  function isSecureOK(){
    const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    return location.protocol === 'https:' || isLocal;
  }

  function thr(){
    const v = Number(thrEl.value);
    return Number.isFinite(v) ? Math.min(1, Math.max(0, v)) : 0.5;
  }
  function inferSize(){
    const v = Number(inferSizeEl.value);
    return Number.isFinite(v) ? v : 512;
  }

  function clearCanvas(){ ctx.clearRect(0,0,canvas.width,canvas.height); }
  function drawFrame(){ ctx.drawImage(video, 0,0,canvas.width,canvas.height); }

  function drawBox(box, score){
    const [ymin,xmin,ymax,xmax] = box;
    const x = xmin*canvas.width, y = ymin*canvas.height;
    const w = (xmax-xmin)*canvas.width, h=(ymax-ymin)*canvas.height;

    ctx.strokeStyle = 'red';
    ctx.lineWidth = 2;
    ctx.strokeRect(x,y,w,h);

    ctx.fillStyle = 'red';
    ctx.font = '16px Arial';
    ctx.fillText((score*100).toFixed(1)+'%', x+4, Math.max(18, y+18));
  }

  function stopCamera(){
    if(stream){
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    video.srcObject = null;
    scanBtn.disabled = true;
    stopBtn.disabled = true;
  }

  async function waitMetadata(){
    await new Promise(resolve => {
      if(video.readyState >= 2 && video.videoWidth > 0) return resolve();
      video.onloadedmetadata = () => resolve();
    });
  }

  // ===== iOS æœ€ä¿å®ˆç›¸æ©Ÿå•Ÿå‹•æµç¨‹ =====
  async function startCameraIOSSafe(){
    if(!navigator.mediaDevices?.getUserMedia) throw new Error('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ getUserMedia()');
    if(!isSecureOK()) throw new Error('éœ€è¦ HTTPS æˆ– localhostï¼š'+location.href);

    setStatus('å•Ÿå‹•ç›¸æ©Ÿä¸­â€¦');
    stopCamera();

    // iOS é—œéµï¼šå†è£œä¸€æ¬¡å±¬æ€§ï¼ˆæœ‰äº›ç‰ˆæœ¬éœ€è¦ï¼‰
    video.setAttribute('playsinline','');
    video.setAttribute('muted','');
    video.muted = true;

    // å…ˆç”¨ getUserMedia æ‹¿ stream
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' } },
      audio: false
    });
    video.srcObject = stream;

    // ç­‰ metadata
    await waitMetadata();

    // iOS é—œéµï¼šç¬¬ä¸€æ¬¡ play
    try { await video.play(); } catch(e) { log('play() 1 failed:', {name:e.name, message:e.message}); }

    // iOS é—œéµï¼šå»¶é²å† play ä¸€æ¬¡ï¼ˆä¸å°‘æ©Ÿå‹éœ€è¦ï¼‰
    await new Promise(r => setTimeout(r, 250));
    try { await video.play(); } catch(e) { log('play() 2 failed:', {name:e.name, message:e.message}); }

    // ç¢ºèªå°ºå¯¸
    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;

    clearCanvas();
    // è‹¥å°šæœªçœŸæ­£å‡ºå½±åƒï¼Œå…ˆä¸ drawï¼ˆé¿å…é»‘ï¼‰
    if(video.videoWidth > 0) drawFrame();

    setStatus(`ç›¸æ©Ÿå·²å•Ÿå‹•ï¼š${canvas.width} x ${canvas.height}`);
    stopBtn.disabled = false;
    scanBtn.disabled = !modelLoaded;
  }

  // ===== æ¨¡å‹è¼‰å…¥ =====
  async function loadModel(){
    setStatus('è¼‰å…¥æ¨¡å‹ä¸­â€¦');
    const path = modelPathEl.textContent.trim();

    model = await tf.loadGraphModel(path);
    modelLoaded = true;

    log('âœ… æ¨¡å‹è¼‰å…¥å®Œæˆ');
    log('inputs:', model.inputs.map(i => ({name:i.name, shape:i.shape, dtype:i.dtype})));
    log('outputs:', model.outputs.map(o => ({name:o.name, shape:o.shape, dtype:o.dtype})));

    setStatus('æ¨¡å‹è¼‰å…¥å®Œæˆ');
    scanBtn.disabled = !stream;
  }

  function disposeOut(out){
    if(Array.isArray(out)) out.forEach(t => t?.dispose?.());
    else Object.values(out).forEach(t => t?.dispose?.());
  }

  function pickOutputs(out){
    let boxesT=null, scoresT=null, numT=null;

    if(Array.isArray(out)){
      boxesT = out[0] || null;
      scoresT = out[1] || null;
      numT = out[3] || null;
      return {boxesT, scoresT, numT};
    }

    boxesT  = out['detection_boxes']  || out['TFLite_Detection_PostProcess']   || null;
    scoresT = out['detection_scores'] || out['TFLite_Detection_PostProcess:1'] || null;
    numT    = out['num_detections']   || out['TFLite_Detection_PostProcess:3'] || null;

    if(!boxesT || !scoresT){
      const keys = Object.keys(out);
      log('â„¹ï¸ output keys:', keys);
      for(const k of keys){
        const t = out[k];
        const s = t?.shape || [];
        if(!boxesT && s.length===3 && s[s.length-1]===4) boxesT = t; // [1,N,4]
        if(!scoresT && s.length===2) scoresT = t; // [1,N]
      }
    }
    return {boxesT, scoresT, numT};
  }

  async function detectOnce(){
    if(!modelLoaded) throw new Error('æ¨¡å‹å°šæœªè¼‰å…¥');
    if(!stream) throw new Error('ç›¸æ©Ÿå°šæœªå•Ÿå‹•');

    // æ›´æ–° canvas å°ºå¯¸
    canvas.width = video.videoWidth || canvas.width;
    canvas.height = video.videoHeight || canvas.height;

    clearCanvas();
    drawFrame();

    const threshold = thr();
    const size = inferSize();
    setStatus(`æ¨è«–ä¸­â€¦ thr=${threshold} size=${size}`);

    const result = await tf.tidy(async () => {
      const img = tf.browser.fromPixels(canvas).toFloat();
      const resized = tf.image.resizeBilinear(img, [size, size], true);
      const input = resized.div(255).expandDims(0);

      const out = await model.executeAsync(input);
      const {boxesT, scoresT, numT} = pickOutputs(out);

      if(!boxesT || !scoresT){
        // å° shapes æ–¹ä¾¿ä½ å°æ¨¡å‹
        if(Array.isArray(out)){
          log('âŒ ç„¡æ³•æ¨æ–· boxes/scoresã€‚Array outputs shapes:');
          out.forEach((t,i)=>log(`  [${i}] shape=`, t.shape));
        }else{
          log('âŒ ç„¡æ³•æ¨æ–· boxes/scoresã€‚Named outputs shapes:');
          Object.entries(out).forEach(([k,t])=>log(`  ${k} shape=`, t.shape));
        }
        disposeOut(out);
        throw new Error('æ¨¡å‹è¼¸å‡ºä¸æ˜¯å¸¸è¦‹åµæ¸¬æ ¼å¼ï¼ˆçœ‹ log çš„ outputs/keys/shapeï¼‰');
      }

      const boxesArr = await boxesT.array();
      const scoresArr = await scoresT.array();
      const numArr = numT ? await numT.array() : null;

      disposeOut(out);

      const boxes = (Array.isArray(boxesArr[0]) && Array.isArray(boxesArr[0][0])) ? boxesArr[0] : boxesArr;
      const scores = (Array.isArray(scoresArr[0])) ? scoresArr[0] : scoresArr;
      const num = (numArr && Array.isArray(numArr)) ? Number(numArr[0]) : null;

      return {boxes, scores, num, threshold};
    });

    // ç•«æ¡†
    clearCanvas();
    drawFrame();

    const {boxes, scores, num, threshold} = result;
    const N = num ? Math.min(num, boxes.length, scores.length) : Math.min(boxes.length, scores.length);

    let count = 0;
    for(let i=0;i<N;i++){
      const sc = scores[i];
      if(sc >= threshold){
        count++;
        drawBox(boxes[i], sc);
      }
    }

    countDiv.textContent = 'åµæ¸¬åˆ°è—¥ç²’æ•¸é‡ï¼š' + count;
    setStatus(`å®Œæˆ âœ… åµæ¸¬ ${count} é¡†ï¼ˆå€™é¸ ${N}ï¼‰`);
  }

  // ===== äº‹ä»¶ =====
  startBtn.addEventListener('click', async () => {
    startBtn.disabled = true;
    try{
      // iOS æœ€ä¿å®ˆç‰ˆæœ¬
      await startCameraIOSSafe();

      // ç¬¬ä¸€æ¬¡å•Ÿå‹•æ™‚è¼‰æ¨¡å‹
      if(!modelLoaded) await loadModel();
    }catch(e){
      log('âŒ startCamera error:', {name:e.name, message:e.message});
      alert('ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼š\n'+(e.name||'Error')+'\n'+e.message);
      setStatus('ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—');
    }finally{
      startBtn.disabled = false;
    }
  });

  stopBtn.addEventListener('click', () => {
    stopCamera();
    setStatus('ç›¸æ©Ÿå·²åœæ­¢');
  });

  scanBtn.addEventListener('click', async () => {
    scanBtn.disabled = true;
    try{
      await detectOnce();
    }catch(e){
      log('âŒ detect error:', {name:e.name, message:e.message});
      alert('æ¨è«–å¤±æ•—ï¼š\n'+e.message);
      setStatus('æ¨è«–å¤±æ•—');
    }finally{
      scanBtn.disabled = false;
    }
  });

  // æ¸¬è©¦æ¬Šé™ï¼šåªæ¸¬ getUserMedia æ˜¯å¦æœƒè¢«å‘¼å«/å›éŒ¯èª¤
  testBtn.addEventListener('click', async () => {
    try{
      if(!isSecureOK()) throw new Error('ä¸æ˜¯ HTTPS/localhostï¼š'+location.href);
      const tmp = await navigator.mediaDevices.getUserMedia({video:true, audio:false});
      tmp.getTracks().forEach(t=>t.stop());
      alert('âœ… æ¬Šé™/ç›¸æ©Ÿå¯ç”¨ï¼ˆgetUserMedia æˆåŠŸï¼‰');
    }catch(e){
      log('âŒ permission test:', {name:e.name, message:e.message});
      alert('âŒ getUserMedia å¤±æ•—ï¼š\n'+(e.name||'Error')+'\n'+e.message);
    }
  });

  // åˆå§‹åŒ–æç¤º
  (function init(){
    log('æç¤ºï¼šGitHub Pages (HTTPS) OKï¼›iOS éœ€è¦ muted + playsinline + æ‰‹å‹• video.play()');
    if(!isSecureOK()) log('âš ï¸ ç›®å‰ä¸æ˜¯ HTTPS/localhostï¼š', location.href);
    setStatus('å°šæœªå•Ÿå‹•');
  })();
</script>
  </script>

  <!-- ğŸ‘‡ğŸ‘‡ğŸ‘‡ å¾é€™è£¡è²¼ä¸Šæˆ‘çµ¦ä½ çš„æ¸¬è©¦ç¢¼ ğŸ‘‡ğŸ‘‡ğŸ‘‡ -->
  <script>
    alert("JS å·²è¼‰å…¥ï¼ˆçœ‹åˆ°é€™å€‹ä»£è¡¨ script æ­£å¸¸ï¼‰");

    const testBtn = document.getElementById('testBtn');
    const logEl = document.getElementById('log');

    function log2(msg){
      console.log(msg);
      if (logEl) logEl.textContent = msg + "\n" + (logEl.textContent || "");
    }

    if (!testBtn) {
      alert("âŒ æ‰¾ä¸åˆ°ã€æ¸¬è©¦æ¬Šé™ã€æŒ‰éˆ•ï¼ˆid=testBtnï¼‰");
    } else {
      testBtn.onclick = async () => {
        alert("âœ… ä½ æœ‰æŒ‰åˆ°ã€æ¸¬è©¦æ¬Šé™ã€æŒ‰éˆ•");

        try {
          const s = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
          s.getTracks().forEach(t => t.stop());
          alert("âœ… getUserMedia æˆåŠŸï¼ˆSafari å·²å…è¨±ç›¸æ©Ÿï¼‰");
        } catch (e) {
          alert("âŒ getUserMedia å¤±æ•—ï¼š" + (e.name || "Error") + "\n" + e.message);
        }
      };
    }
  </script>
  <!-- ğŸ‘†ğŸ‘†ğŸ‘† è²¼åˆ°é€™è£¡ ğŸ‘†ğŸ‘†ğŸ‘† -->

</body>
</html>

