<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>è—¥ç²’è¨ˆæ•¸ WebApp (AIç‰ˆ)</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    video, canvas { width: 90%; max-width: 400px; margin: 10px; }
    #count { font-size: 1.5em; color: darkblue; margin-top: 15px; }
    button { font-size: 1.2em; padding: 10px 20px; margin-top: 15px; }
  </style>
</head>
<body>
  <h1>ğŸ’Š è—¥ç²’è¨ˆæ•¸ WebApp (AIç‰ˆ)</h1>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>
  <button id="scanBtn">ğŸ“¸ æƒæä¸¦è¨ˆæ•¸</button>
  <div id="count">åµæ¸¬åˆ°è—¥ç²’æ•¸é‡ï¼š0</div>

  <!-- å¼•å…¥ TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <!-- å‡è¨­ä½ æœ‰ä¸€å€‹è¨“ç·´å¥½çš„æ¨¡å‹ pill-model.json -->
  <script>
    let model;
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const countDiv = document.getElementById('count');
    const scanBtn = document.getElementById('scanBtn');

    // å•Ÿç”¨ç›¸æ©Ÿ
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => { video.srcObject = stream; });

    // è¼‰å…¥æ¨¡å‹
    async function loadModel() {
      model = await tf.loadGraphModel('pill-model/model.json'); 
      console.log("æ¨¡å‹è¼‰å…¥å®Œæˆ");
    }
    loadModel();

    // æŒ‰ä¸‹æŒ‰éˆ• â†’ æ‹ç…§ä¸¦åˆ†æ
    scanBtn.addEventListener('click', async () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // è½‰æˆ Tensor
      let imgTensor = tf.browser.fromPixels(canvas).expandDims(0).toFloat().div(255);

      // æ¨¡å‹æ¨è«–
      const predictions = await model.executeAsync(imgTensor);

      // å‡è¨­æ¨¡å‹è¼¸å‡ºæ˜¯ [boxes, scores, classes]
      const boxes = predictions[0].arraySync();
      const scores = predictions[1].arraySync();
      let pillCount = 0;

      for (let i = 0; i < scores.length; i++) {
        if (scores[i] > 0.5) { // ä¿¡å¿ƒåº¦é–¾å€¼
          pillCount++;
          let [ymin, xmin, ymax, xmax] = boxes[i];
          ctx.strokeStyle = "red";
          ctx.lineWidth = 2;
          ctx.strokeRect(xmin * canvas.width, ymin * canvas.height,
                         (xmax - xmin) * canvas.width, (ymax - ymin) * canvas.height);
        }
      }

      countDiv.textContent = "åµæ¸¬åˆ°è—¥ç²’æ•¸é‡ï¼š" + pillCount;

      // æ¸…ç†
      predictions.forEach(p => p.dispose && p.dispose());
      imgTensor.dispose();
    });
  </script>
</body>
</html>

